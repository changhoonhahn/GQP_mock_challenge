\begin{figure}
\begin{center}
\includegraphics[width=0.9\textwidth]{figs/inferred_props.pdf}
\caption{
    Comparison between the true galaxy properties, $\theta_{\rm true}$, and
    those inferred from SED modeling of mock observations, $\hat{\theta}$. 
    From the left to right columns, we compare $\log M_*$, $\log \avgsfr$, 
    $\log Z_{\rm MW}$, and $\tau_{\rm ISM}$. 
    The inferred galaxy properties are derived from SED modeling of mock
    spectra (top), photometry (middle), and spectra + photometry (bottom). 
    For each simulated galaxy, we represent the marginalized posterior of
    $\theta$ with a violin plot.  %We derive unbiased and precise $\log M_*$
    } \label{fig:prop_inf}
\end{center}
\end{figure}

\section{Results} \label{sec:results}
%\subsection{Inferred Galaxy Properties}
The goal of this work is to demonstrate the precision and accuracy of inferred
galaxy properties for PROVABGS. 
We apply our SED modeling to the mock observables of \todo{100} \lgal~galaxies.
From the posterior distributions of the SPS parameters, we derive the following
physical galaxy properties: stellar mass ($M_*$), SFR averaged over 1 Gyr
($\avgsfr$), mass-weighted stellar metallicity ($Z_{\rm MW}$), and diffuse-dust
optical depth ($\tau_{\rm ISM}$).
$M_*$ and $\tau_{\rm ISM}$ are both SPS model parameters. 
We derive $\avgsfr$ and $Z_{\rm MW}$ as 
\begin{equation}
    \avgsfr = \frac{\int\limits_{t_{\rm age} - {\rm 1 Gyr}}^{t_{\rm age}}{\rm
    SFH}(t)\,{\rm d}t}{{\rm 1 Gyr}} \quad{\rm and}\quad
    Z_{\rm MW} = \frac{\int\limits_0^{t_{\rm age}}{\rm SFH}(t)\,{\rm
    ZH}(t)\,{\rm d}t}{M_*}.
\end{equation} 

In Figure~\ref{fig:prop_inf}, we compare the galaxy properties inferred from
SED modeling the mock observations, $\hat{\theta}$ to the true (input) galaxy
properties, $\theta_{\rm true}$ of the simulated galaxies.
In each column, we compare $\log M_*$, $\log \avgsfr$, $\log Z_{\rm MW}$, and
$\tau_{\rm ISM}$ from left to right. 
The inferred properties in the top, middle, and bottom rows are derived from
SED modeling of spectra, photometry, and spectra + photometry, respectively.
In each panel, we plot $\hat{\theta}$ using a violin plot, where the width
of the marker represents the marginalized posterior distribution of $\theta$. 
We note that in the comparison with SED modeling spectra only, we do not
include $f_{\rm fiber}$. 
Therefore, the true stellar mass in this case corresponds to $f_{\rm fiber}
\times M_*$. 
\emph{Overall, the comparison demonstrates that we can robustly infer galaxy
properties using the {\sc PROVABGS} SED modeling}. 

In more detail, we find that we infer unbiased and precise constraints on
$M_*$ throughout the entire $M_*$ range. 
%For spectra+photometry SED modeling, the posteriors have $\sigma_{M_*}\sim0.06$ dex.
We also infer robust $\avgsfr$ for $\log \avgsfr > -2$ dex; below this limit,
however, the inferred $\avgsfr$ are significantly less precise and
overestimated the true $\avgsfr$. 
This bias at low $\avgsfr$ is caused by model priors, which we discuss in
further detail later in \todo{Section~\ref{sec:discuss} and
Appendix~\ref{sec:model_priors}}. 
$Z_{\rm MW}$ is not precisely constrained ($\sigma_{\log Z_{\rm MW}} \sim 0.1$
dex); however, there is no strong bias in the constraints. 
Lastly, $\tau_{\rm ISM}$ is accurately inferred for simulated galaxies with
low $\tau_{\rm ISM}$ but the accuracy declines significantly for high 
$\tau_{\rm ISM}$ galaxies. 

The overall unbiased constraints on galaxy properties for the mock observations
is especially encouraging due to the significant differences in the forward
model used to generate the observations and the SPS model used in the SED
modeling. 
First, the SFH in the forward model is taken directly from \lgal~simulation
outputs while the SFH parameterization in the SPS model is based on NMF bases fit
to IllustrisTNG galaxy SFHs.
Second, in the forward model, we construct the SED of the bulge and disk
components of the simulated galaxies separately: the components have separate
SFHs and ZHs. 
Lastly, we use different dust prescriptions: \cite{mathis1983} dust attenuation  
curve in the forward model and \cite{kriek2013} dust attenuation curve in the
SPS model. 
Despite these significant differences our constraints on galaxy properties are
unbiased. 

Figure~\ref{fig:prop_inf}, also highlights the advantages of jointly modeling
spectra and photometry. 
Comparing the constraints from spectra+photometry to photometry alone, we find
that including spectra significantly tightens the constraints for all
properties. 
In addition to tightening constraints, including spectra also reduces the bias
of the constraints. 
For instance, with only photometry, we derive biased $\avgsfr$ constraints for
some of the galaxies. 
This is due to the limited constraining power of photometry, which allows the
posteriors to be dominated by model priors. 
Adding spectra, significantly increases the contribution of the likelihood and
ameliorates this effect. 
%Therefore, joint SED modeling of spectra and photometry 

We want to examine the precision and accuracy of the inferred galaxy properties
beyond qualitative comparisons of the posteriors. 
Let $\Delta_{\theta,i}$ be the discrepancy between the inferred and true
parameters for each galaxy: $\hat{\theta}_i = \theta^{\rm true}_i +
\Delta_{\theta,i}$.
Then, if we assume that $\Delta_{\theta,i}$ are sampled from a Gaussian
distribution,
\begin{equation} \label{eq:eta_gauss}
    \Delta_{\theta,i} \sim \mathcal{N}(\mu_{\Delta_{\theta}}, \sigma_{\Delta_{\theta}}),
\end{equation}
the mean ($\mu_{\Delta_{\theta}}$) and standard deviation
($\sigma_{\Delta_{\theta}}$) of the distribution represent the accuracy and
precision of the inferred posteriors for the galaxy population. 
Therefore, to quantify the bias and precision of our SED modeling, we derive the 
population hyperparameters ($\mu_{\Delta_{\theta}}, \sigma_{\Delta_{\theta}}$)
using a hierarchical Bayesian framework~\citep[\emph{e.g.}][]{hogg2010,
foreman-mackey2014, baronchelli2020}.


\begin{figure}
\begin{center}
    \includegraphics[width=\textwidth]{figs/etas.pdf} \label{fig:etas}
    \caption{
        The accuracy and precision of our joint SED modeling of
        spectra+photometry, quantified using population hyperparameters
        $\mu_{\Delta_{\theta}}$ and $\sigma_{\Delta_{\theta}}$, as a function
        of true galaxy property (green). 
        We plot $\mu_{\Delta_{\theta}}$ in solid line and
        $\sigma_{\Delta_{\theta}}$ in the shaded region.
        We include $\{\mu_{\Delta_{\theta}}, \sigma_{\Delta_{\theta}}\}$ for SED
        modeling of photometry alone (orange) for comparison. 
    }
\end{center}
\end{figure}

Let $\{{\bfi X}_i\}$ represent the photometry or spcetrum of a galaxy
population and $\eta_\Delta = \{\mu_{\Delta_{\theta}},
\sigma_{\Delta_{\theta}}\}$ be the population hyperparameters.
Our goal is to constrain $\eta_\Delta$ from $\{{\bfi X}_i\}$ --- \emph{i.e.}
$p(\eta_\Delta \given \{{\bfi X}_i\})$.
As usual, we can expand 
\begin{align}
p(\eta_\Delta \given \{{\bfi X_i}\}) 
    =&~\frac{p(\eta_\Delta)~p( \{{\bfi X_i}\} \given \eta_\Delta)}{p(\{{\bfi X_i}\})}\\
    =&~\frac{p(\eta_\Delta)}{p(\{{\bfi X_i}\})}\int p(\{{\bfi X_i}\} \given \{\theta_i\})~p(\{\theta_i\} \given \eta_\Delta)~{\rm d}\{\theta_i\}.
\end{align} 
$\theta_i$ is the SPS parameters for galaxy $i$ and $p(\{{\bfi X_i}\} \given
\{\theta_i\})$ is likelihood of the set of observations $\{{\bfi X_i}\}$ given
the set of $\{\theta_i\}$. 
Since the likelihoods for each of the $N$ galaxies ($p(\bfi X_i \given
\theta_i)$) are not correlated, we can factorize and write the expression above
as 
\begin{align}
p(\eta_\Delta \given \{{\bfi X_i}\}) 
    =&~\frac{p(\eta_\Delta)}{p(\{{\bfi X_i}\})}\prod\limits_{i=1}^N\int p({\bfi X_i} \given \theta_i)~p(\theta_i \given \theta_\Delta)~{\rm d}\theta_i\\
    =&~\frac{p(\eta_\Delta)}{p(\{{\bfi X_i}\})}\prod\limits_{i=1}^N\int
    \frac{p(\theta_i \given {\bfi X_i})~p({\bfi X_i})}{p(\theta_i)}~p(\theta_i
    \given \eta_\Delta)~{\rm d}\theta_i\\
    =&~p(\eta_\Delta)\prod\limits_{i=1}^N\int \frac{p(\theta_i \given {\bfi
    X_i})~p(\theta_i \given \eta_\Delta)}{p(\theta_i)}~{\rm d}\theta_i. 
\intertext{
    $p(\theta_i \given {\bfi X_i})$ is the posterior for an individual galaxy,
    so the integral can be estimated using the Monte Carlo samples from the
    posterior: 
}
    \approx&~p(\eta_\Delta)\prod\limits_{i=1}^N\frac{1}{S_i}\sum\limits_{j=1}^{S_i}
    \frac{p(\theta_{i,j} \given \eta_\Delta)}{p(\theta_{i,j})}.
\end{align} 
$S_i$ is the number of posterior samples and $\theta_{i,j}$ is the $j^{\rm th}$
sample of galaxy $i$.
In practice,
$p(\theta_{i,j} \given \eta_\Delta) = p(\Delta_{\theta,i,j} \given
\eta_\Delta)$ is a Gaussian distribution and, hence, easy to evaluate
(Eq.~\ref{eq:eta_gauss}. 
$p(\theta_{i,j}) = 1$ since we use uninformative and Dirichlet priors
(Table~\ref{tab:params}). 
Lastly, we derive $p(\eta_\Delta \given \{{\bfi X_i}\})$ by sampling the
distribution using MCMC.

In Figure~\ref{fig:etas}, we present the accuracy and precision
($\mu_{\Delta_{\theta}}, \sigma_{\Delta_{\theta}}$) of our joint
SED modeling of spectra and photometry (green) as a function of true galaxy
property. 
We use the median of $p(\eta_\Delta \given \{{\bfi X_i}\})$ for
$\mu_{\Delta_{\theta}}$ (solid) and $\sigma_{\Delta_{\theta}}$ (shaded region).
And in each panel, we derive $p(\eta_\Delta \given \{{\bfi X_i}\})$ for each
property bin using the galaxies within it.
We use bins with widths of \todo{0.2, 0.2, 0.05, and 0.1 dex} for $\log
M_*$, $\avgsfr$, $\log Z_{\rm MW}$, and $\tau_{\rm ISM}$ respectively and only
include bins with more than one galaxy. 

For $\log M_*$ and $\tau_{\rm ISM}$ we find no bias in $\mu_{\Delta_{\theta}}$
even as a function of galaxy property. 
On the other hand, we confirm the significant bias in $\avgsfr$ at low $\avgsfr
< -1$ dex: inferred $\avgsfr$ is biased by $\gtrsim 0.2$ dex at the SFRs. 
There is also a noticeable bias in $\log Z_{\rm MW}$, which was difficult to
detect in Figure~\ref{fig:prop_inf}. 
However, the bias is small compared to the precision ($\mu_{\Delta_{\theta}}
\sim 0.1$ dex) and is independent of the true $\log Z_{\rm MW}$. 

The biases in $\avgsfr$ and $\log Z_{\rm MW}$ are both a consequence of our SPS
model priors (Appendix~\ref{sec:model_priors}). 
While $\log M_*$ and $\tau_{\rm ISM}$ are directly parameters in our SPS model
and, thus, have uniform priors.
$\avgsfr$ and $\log Z_{\rm MW}$, however, are derived quantities so the uniform
priors we impose on SPS parameters induce non-uniform priors $\avgsfr$ and
$\log Z_{\rm MW}$.
For our SPS model, we impose a prior on $\log \overline{\rm SSFR}_{\rm 1 Gyr}$
that is skewed and peaks at ${\sim}-10.4$ dex (Figure~\ref{fig:model_priors}). 
Consequently, the posterior overestimates $\avgsfr$ at low $\avgsfr$.
We also impose a skewed prior on $\log Z_{\rm MW}$; however, the prior is
significantly broader so the posteriors are only slightly biased. 

In Figure~\ref{fig:etas}, we also include $\{\mu_{\Delta_{\theta}},
\sigma_{\Delta_{\theta}}\}$ for SED modeling of photometry alone (orange). 
Comparing $\sigma_{\Delta_{\theta}}$, we confirm that including spectra
significantly tightens the constraints on all of the galaxy properties. 
\todo{  % update with final calculations
    For instance, $\sigma_{\Delta_{\theta}}$ for $M_*$ improves from X to X dex
    once spectra is included.
} 
In addition to the increased precision, including spectra significantly
improves the bias in the inferred galaxy properties. 
\todo{
    This is especially clear for $\avgsfr$, where the bias is reduced by X dex
    at $\avgsfr \sim -2$ dex. 
    The bias on $Z_{\rm MW}$ is also noticeably reduced. 
}
Overall, Figure~\ref{fig:etas} illustrates that we derive overall unbiased
constraints on galaxy properties, except for low $\avgsfr$ galaxies, and that
including spectra in the SED modeling substantially improves the inferred
galaxy properties. 

\begin{figure}
\begin{center}
    \includegraphics[width=0.95\textwidth]{figs/etas_photo.pdf}
    \caption{
        Accuracy and precision of the galaxy properties inferred from joint SED
        modeling of spectra+photometry as a function of $r_{\rm fiber}$, $r$,
        $g-r$, and $r-z$.
        From the top to bottom rows, we present $\eta_\Delta$ for $\log M_*$,
        $\avgsfr$, $\log Z_{\rm MW}$, and $\tau_{\rm ISM}$.
        $r_{\rm fiber}$ and $r$ magnitudes are proxies for SNR of spectra and
        photometry. 
        $g-r$ and $r-z$ are the optical photometric colors. 
        We find no significant dependence on SNR or color in the accuracy of
        the inferred $\log M_*$, $\log Z_{\rm MW}$, and $\tau_{\rm ISM}$. 
    } 
    \label{fig:systematics}
\end{center}
\end{figure}


Beyond quantifying the accuracy and precision of our parameter inference as a
function of galaxy properties, we examine how our parameter inference is
impacted by signal-to-noise ratio (SNR) and photometric color. 
In Figure~\ref{fig:systematics}, we present $\eta_\Delta$ of our joint
SED modeling of spectra and photometry as a function of $r_{\rm fiber}$, $r$,
$g-r$, and $r-z$. 
In each row, we plot $\eta_\Delta$ for a different galaxy property: $\log M_*$,
$\avgsfr$, $\log Z_{\rm MW}$, and $\tau_{\rm ISM}$ (from top to bottom).
$r_{\rm fiber}$ and $r$ magnitudes serve proxies of the SNR for the spectra and
photometry, respectively. 
Besides $\avgsfr$, we find no significant dependence on SNR or color in the
inferred galaxy properties. 
We again confirm that the inferred $M_*$ and $\tau_{\rm ISM}$ values are
unbiased.
While the inferred $Z_{\rm MW}$ overestimate the true $Z_{\rm MW}$, the bias is
small $\sim 0.1$ dex and, more importantly, independent of SNR or color. 
Together with the results from Figure~\ref{fig:etas}, \emph{we conclude that with our
SED modeling we can infer robust constraints on $M_*$, $Z_{\rm MW}$, and
$\tau_{\rm ISM}$}.

The situation is more complex for $\avgsfr$. 
For galaxies with high SNR spectra and photometry, we find no significant bias
in the inferred $\avgsfr$. 
However, for $r_{\rm fiber} > 20.5$ and $r > 19$, inferred $\avgsfr$
overestimates the true $\avgsfr$. 
\todo{color dependence once we get to the bottom of that}  


\begin{figure}
\begin{center}
    \includegraphics[width=\textwidth]{figs/etas_msfr.pdf} \label{fig:etas_msfr}
    \caption{
    }
\end{center}
\end{figure}

