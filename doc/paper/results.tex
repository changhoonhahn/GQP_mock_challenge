\begin{figure}
\begin{center}
\includegraphics[width=0.9\textwidth]{figs/inferred_props.pdf}
\caption{
    Comparison between the true galaxy properties, $\theta_{\rm true}$, and
    those inferred from SED modeling of mock observations, $\hat{\theta}$. 
    From the left to right columns, we compare $\log M_*$, $\log \avgsfr$, 
    $\log Z_{\rm MW}$, $\tage$ and $\tauism$. 
    The inferred galaxy properties are derived from SED modeling of mock
    spectra (top), photometry (middle), and spectrophotometry (bottom). 
    For each simulated galaxy, we represent the marginalized posterior of
    $\theta$ with a violin plot.  %We derive unbiased and precise $\log M_*$
    \emph{The posteriors demonstrate that, overall, we can derive accurate and 
    precise constraints on certain galaxy properties from joint SED modeling of
    DESI photometry and spectra.}
    } \label{fig:prop_inf}
\end{center}
\end{figure}

\section{Results} \label{sec:results}
%\subsection{Inferred Galaxy Properties}
The goal of this work is to demonstrate the precision and accuracy of inferred
galaxy properties for PROVABGS. 
We apply our SED modeling to the mock observables of \todo{100} \lgal~galaxies.
From the posterior distributions of the SPS parameters, we derive the following
physical galaxy properties: stellar mass ($M_*$), SFR averaged over 1 Gyr
($\avgsfr$), mass-weighted stellar metallicity ($Z_{\rm MW}$), and diffuse-dust
optical depth ($\tau_{\rm ISM}$).
$M_*$ and $\tau_{\rm ISM}$ are both SPS model parameters. 
We derive $\avgsfr$ and $Z_{\rm MW}$ as 
\begin{equation}
    \avgsfr = \frac{\int\limits_{t_{\rm age} - {\rm 1 Gyr}}^{t_{\rm age}}{\rm
    SFH}(t)\,{\rm d}t}{{\rm 1 Gyr}} \quad{\rm and}\quad
    Z_{\rm MW} = \frac{\int\limits_0^{t_{\rm age}}{\rm SFH}(t)\,{\rm
    ZH}(t)\,{\rm d}t}{M_*}.
\end{equation} 

In Figure~\ref{fig:prop_inf}, we compare the galaxy properties inferred from
SED modeling the mock observations, $\hat{\theta}$ to the true (input) galaxy
properties, $\theta_{\rm true}$ of the simulated galaxies.
In each column, we compare $\log M_*$, $\log \avgsfr$, $\log Z_{\rm MW}$,
$\tage$, and $\tauism$ from left to right.  
The inferred properties in the top, middle, and bottom rows are derived from
SED modeling of spectra, photometry, and spectrophotometry, respectively.
In each panel, we plot $\hat{\theta}$ using a violin plot, where the width
of the marker represents the marginalized posterior distribution of $\theta$. 
We note that in the comparison with SED modeling spectra only, we do not
include $f_{\rm fiber}$. 
Therefore, the true stellar mass in this case corresponds to $f_{\rm fiber}
\times M_*$. 
\emph{Overall, the comparison demonstrates that we can robustly infer galaxy
properties using the {\sc PROVABGS} SED modeling}. 

In more detail, we find that we infer unbiased and precise constraints on
$M_*$ throughout the entire $M_*$ range. 
%For spectra+photometry SED modeling, the posteriors have $\sigma_{M_*}\sim0.06$ dex.
We also infer robust $\avgsfr$ above $\log \avgsfr > -1$ dex; below this limit,
however, the inferred $\avgsfr$ are significantly less precise and
overestimate the true $\avgsfr$. 
This bias at low $\avgsfr$ is caused by model priors, which we discuss in
further detail later in \todo{Section~\ref{sec:discuss} and
Appendix~\ref{sec:model_priors}}. 
Both $Z_{\rm MW}$ and $\tage$ are not precisely constrained. 
However, Figure~\ref{fig:prop_inf} does not exhibit clear biases in the
constraints.
For $\tage$, the posteriors reveal the log-spaced $\tlb$ binning used in our
SPS model for $\tage > 6$ Gyr.
Lastly, $\tauism$ is overally accurately inferred for galaxies with low
$\tauism$ but appears to be underestimated for for high $\tauism$.

The overall constraints on galaxy properties for the mock observations is
especially encouraging due to the significant differences in the forward
model used to generate the observations and the SPS model used in the SED
modeling. 
First, the SFHs in the mock observations are taken directly from \lgal~simulation
outputs while the SFH parameterization in the SPS model is based on NMF bases fit
to IllustrisTNG galaxy SFHs.
Second, in the forward model, we construct the SED of the bulge and disk
components of the simulated galaxies separately: the components have separate
SFHs and ZHs. 
Lastly, we use different dust prescriptions: \cite{mathis1983} dust attenuation  
curve in the forward model and \cite{kriek2013} dust attenuation curve in the
SPS model. 
Despite these significant differences, our constraints on certain galaxy
properties are unbiased and precise. 

Figure~\ref{fig:prop_inf}, also highlights the advantages of jointly modeling
spectra and photometry. 
Comparing the constraints from spectrophotometry to photometry alone, we find
that including spectra significantly tightens the constraints for all
properties. 
In addition to tightening constraints, including spectra also appears to reduce
biases of the constraints. 
For instance, with only photometry, we derive significantly more biased
$\avgsfr$ constraints.
This is due to the limited constraining power of photometry, which allows the
posteriors to be dominated by model priors. 
Adding spectra, significantly increases the contribution of the likelihood and
ameliorates this effect. 
%Therefore, joint SED modeling of spectra and photometry 

Beyond qualitative comparisons of the posterior, we want to quantify the
precision and accuracy of the inferred galaxy properties. 
Let $\Delta_{\theta,i}$ be the discrepancy between the inferred and true
parameters for each galaxy: 
$\Delta_{\theta,i} = \hat{\theta}_i - \theta^{\rm true}_i$.
Then, if we assume that $\Delta_{\theta,i}$ are sampled from a Gaussian
distribution,
\begin{equation} \label{eq:eta_gauss}
    \Delta_{\theta,i} \sim \mathcal{N}(\mu_{\Delta_{\theta}}, \sigma_{\Delta_{\theta}}),
\end{equation}
the mean ($\mu_{\Delta_{\theta}}$) and standard deviation
($\sigma_{\Delta_{\theta}}$) of the distribution are population hyperparameters
that represent the accuracy and precision of the inferred posteriors for the
galaxy population. 
We can derive $\mu_{\Delta_{\theta}}$ and $\sigma_{\Delta_{\theta}}$ using a
hierarchical Bayesian framework~\citep[\emph{e.g.}][]{hogg2010,
foreman-mackey2014, baronchelli2020}.

Let $\{{\bfi X}_i\}$ represent the photometry or spcetrum of a galaxy
population and $\eta_\Delta = \{\mu_{\Delta_{\theta}},
\sigma_{\Delta_{\theta}}\}$ be the population hyperparameters.
Our goal is to constrain $\eta_\Delta$ from $\{{\bfi X}_i\}$ --- \emph{i.e.}
$p(\eta_\Delta \given \{{\bfi X}_i\})$.
As usual, we can expand 
\begin{align}
p(\eta_\Delta \given \{{\bfi X_i}\}) 
    =&~\frac{p(\eta_\Delta)~p( \{{\bfi X_i}\} \given \eta_\Delta)}{p(\{{\bfi X_i}\})}\\
    =&~\frac{p(\eta_\Delta)}{p(\{{\bfi X_i}\})}\int p(\{{\bfi X_i}\} \given \{\theta_i\})~p(\{\theta_i\} \given \eta_\Delta)~{\rm d}\{\theta_i\}.
\intertext{
    $\theta_i$ is the SPS parameters for galaxy $i$ and $p(\{{\bfi X_i}\}
    \given \{\theta_i\})$ is likelihood of the set of observations $\{{\bfi
    X_i}\}$ given the set of $\{\theta_i\}$. 
    Since the likelihoods for each of the $N$ galaxies, $p(\bfi X_i \given
    \theta_i)$, are not correlated, we can factorize and write the expression
    above as 
}
    =&~\frac{p(\eta_\Delta)}{p(\{{\bfi X_i}\})}\prod\limits_{i=1}^N\int p({\bfi X_i} \given \theta_i)~p(\theta_i \given \theta_\Delta)~{\rm d}\theta_i\\
    =&~\frac{p(\eta_\Delta)}{p(\{{\bfi X_i}\})}\prod\limits_{i=1}^N\int
    \frac{p(\theta_i \given {\bfi X_i})~p({\bfi X_i})}{p(\theta_i)}~p(\theta_i
    \given \eta_\Delta)~{\rm d}\theta_i\\
    =&~p(\eta_\Delta)\prod\limits_{i=1}^N\int \frac{p(\theta_i \given {\bfi
    X_i})~p(\theta_i \given \eta_\Delta)}{p(\theta_i)}~{\rm d}\theta_i. 
\intertext{
    $p(\theta_i \given {\bfi X_i})$ is the posterior for an individual galaxy,
    so the integral can be estimated using the Monte Carlo samples from the
    posterior: 
}
    \approx&~p(\eta_\Delta)\prod\limits_{i=1}^N\frac{1}{S_i}\sum\limits_{j=1}^{S_i}
    \frac{p(\theta_{i,j} \given \eta_\Delta)}{p(\theta_{i,j})}.
\end{align} 
$S_i$ is the number of posterior samples and $\theta_{i,j}$ is the $j^{\rm th}$
sample of galaxy $i$.
In practice,
$p(\theta_{i,j} \given \eta_\Delta) = p(\Delta_{\theta,i,j} \given
\eta_\Delta)$ is a Gaussian distribution and, hence, easy to evaluate. 
$p(\theta_{i,j}) = 1$ since we use uninformative and Dirichlet priors
(Table~\ref{tab:params}). 
Lastly, we sample the $p(\eta_\Delta \given \{{\bfi X_i}\})$ distribution using
MCMC.

\begin{figure}
\begin{center}
    \includegraphics[width=0.85\textwidth]{figs/etas_v2.pdf}
    \caption{
        The accuracy and precision of galaxy property posteriors from our
        joint SED modeling of spectrophotometry, quantified using population
        hyperparameters $\mu_{\Delta_{\theta}}$ and $\sigma_{\Delta_{\theta}}$,
        as a function of true galaxy property (green). 
        We plot $\theta_{\rm true} + \mu_{\Delta_{\theta}}$ in solid line and
        represent $\sigma_{\Delta_{\theta}}$ with the shaded region.
        We include $\{\mu_{\Delta_{\theta}}, \sigma_{\Delta_{\theta}}\}$ for SED
        modeling of photometry alone (orange) for comparison. 
        Including DESI spectra significantly improves both the accuracy and
        precision of the inferred galaxy properties. 
        $\log\avgsfr$, $\log Z_{\rm MW}$, and $\tage$ constraints are significantly
        impacted by well-characterized priors imposed by our SPS model.
        Meanwhile, discrepancies in the dust prescriptions between our SPS
        model and the mock observations drive the bias in $\tauism$.
        \emph{
            Nevertheless, we accurately and precisely infer: 
            $\log M_*$ for all $M_*$, $\log\avgsfr$ above $\log\avgsfr > -1\,{\rm
            dex}$, and $\tage$ below $8\,{\rm Gyr}$.
        }
        } \label{fig:etas}
\end{center}
\end{figure}

In Figure~\ref{fig:etas}, we present the accuracy ($\mu_{\Delta_{\theta}}$) and
precision ($\sigma_{\Delta_{\theta}}$) of our joint SED modeling of spectra and
photometry (green) as a function of true galax property. 
In each panel, we derive $p(\eta_\Delta \given \{{\bfi X_i}\})$ for 
$\log M_*$, $\avgsfr$, $\log Z_{\rm MW}$, $\tage$, and $\tauism$ in bins of
widths 0.2 dex, 0.5 dex, 0.05 dex, 0.5 Gyr, and 0.1, respectively. 
We only include bins with more than three galaxies. 
$\mu_{\Delta_{\theta}}$ (solid) and $\sigma_{\Delta_{\theta}}$ (shaded region)
are the median values of $p(\mu_{\Delta_{\theta}}, \sigma_{\Delta_{\theta}}
\given \{{\bfi X_i}\})$ posterior. 

For $\log M_*$ we find no significant bias in $\mu_{\Delta_{\log M_*}}$ --- we
accurately infer the true $M_*$ throughout the entire $M_*$ range. 
Also, the precision is uniform, $\sigma_{\Delta_{\log M_*}} \sim 0.1$ dex, 
for all $M_*$. 
For $\log \avgsfr$, we accurately infer the true values for $\log \avgsfr > -1$
dex.
Below this limit, we significantly overestimate $\log \avgsfr$, consistent with
the bias in Figure~\ref{fig:prop_inf}. 
In fact, we find a $\log \avgsfr \sim -1$ dex lower bound for the inferred
$\log \avgsfr$. 
In terms of precision, we derive tight constraints $\sigma_{\Delta_{\log M_*}}
\sim 0.1$ dex from $-1 < \log \avgsfr < 1$ dex but broader constraints
$\sigma_{\Delta_{\log M_*}} \sim 0.25 - 0.3$ dex outside this range. 
%Again, the imprecision of the $\avgsfr$ constrants is due to model priors (see Section~\ref{sec:discuss} and Appendix~\ref{sec:model_priors}}. 

For $\log Z_{\rm MW}$, Figure~\ref{fig:etas} reveals a $\log Z_{\rm MW}$
dependent bias in the inferred values. 
We overestimate $\log Z_{\rm MW}$ by $\sim 0.2$ dex below $\log Z_{\rm MW} <
-1.8$ dex and may underestimate $\log Z_{\rm MW}$ at the highest $Z_{\rm MW}$.
Meanwhile, $\sigma_{\Delta_{\log Z_{\rm MW}}} \sim 0.15$ dex is constant
throughout the $Z_{\rm MW}$ range, so the bias is small in comparison.
For $\tage$, we derive unbiased and precise constraints out to $\tage < 8$ Gyr. 
For galaxies with older stellar populations, the log-spaced $\tlb$ binning in
our SPS model (Section~\ref{sec:sps}) expectedly results in underestimated  
$\tage$ constraints with larger uncertainties 
($\sigma_{\Delta_{\tage}} \gtrsim 1$ Gyr). 
Lastly, for $\tauism$ we find a significant $\tauism$ dependence bias in both
accuracy and precision. 
The inferred values increasingly underestimate $\tauism$ with less precise
constraints for greater $\tauism$.

The biases in $\avgsfr$, $Z_{\rm MW}$, $\tage$ are all a consequence of our SPS
model priors (Appendix~\ref{sec:model_priors}). 
$\avgsfr$, $Z_{\rm MW}$, and $\tage$ are derived quantities; hence, the uniform
priors we impose on SPS parameters induce non-uniform priors on them.
For our SPS model, we impose a prior on $\log \overline{\rm SSFR}_{\rm 1 Gyr}$
that is skewed and peaks at ${\sim}-10.4$ dex (Figure~\ref{fig:model_priors}). 
Consequently, the posterior overestimates $\avgsfr$ at low $\avgsfr$.
The SPS model also imposes skewed priors on $\log Z_{\rm MW}$ and $\tage$,
which causes to overestimate $\log Z_{\rm MW}$ for low $Z_{\rm MW}$ galaxies
and underestimate $\tage$ for galaxies with older stellar population. 

The bias in our $\tauism$ constraint is primarily due to intentially included
discrepancies between the SPS model and the mock observations included. 
First, as we stated earlier, we use a dust prescription with a different
attenuation curve in the SPS model than in the forward model. 
This already places a limit on how accurately we can derive $\tauism$; however,
we introduced this discrepancy since we do not know the ``true'' attenuation
curve of observed galaxies in practice. 
Another reason for the biased $\tauism$ constraints is that we only attenuate
the stellar emission in the disk component of the simulated galaxies and not
the bulge component (Section~\ref{sec:sed}).
The true $\tauism$ is the optical depth for the disk componenet while our
$\tauism$ constraints correspond to the optical depth of dust attenuation
for the entire galaxies, a quantity that will be lower than the true $\tauism$
depending on how much the bulge contributes to the SED. 

In Figure~\ref{fig:etas}, we also include $\{\mu_{\Delta_{\theta}},
\sigma_{\Delta_{\theta}}\}$ for SED modeling of photometry alone (orange) for
comparison. 
We confirm that including spectra significantly tightens the constraints on all
of the galaxy properties. 
\todo{  % update with final calculations
    For instance, $\sigma_{\Delta_{\theta}}$ for $M_*$ improves from X to X dex
    once spectra is included.
} 
In addition to the increased precision, including spectra significantly
reduces the bias in the inferred galaxy properties. 
This is especially clear for $\avgsfr$ below $\log\avgsfr < -1$ dex, where the
bias is reduced by ${\sim}1$ dex --- an order of magnitude. 
The overall bias on $Z_{\rm MW}$ is also reduced by $\sim0.3$ dex. 
%Overall, Figure~\ref{fig:etas} illustrates that we derive overall unbiased constraints on galaxy properties, except for low $\avgsfr$ galaxies, and that including spectra in the SED modeling substantially improves the inferred galaxy properties. 

\begin{figure}
\begin{center}
    \includegraphics[width=0.95\textwidth]{figs/etas_photo.pdf}
    \caption{
        Accuracy and precision of the galaxy properties inferred from joint SED
        modeling of spectra+photometry as a function of $r_{\rm fiber}$, $r$,
        $g-r$, and $r-z$.
        From the top to bottom rows, we present $\eta_\Delta$ for $\log M_*$,
        $\log\avgsfr$, $\log Z_{\rm MW}$, $t_{\rm age, MW}$ and $\tau_{\rm ISM}$.
        $r_{\rm fiber}$ and $r$ magnitudes are proxies for SNR of spectra and
        photometry. 
        $g-r$ and $r-z$ are the optical photometric colors. 
        %We find no significant dependence on SNR or color in the accuracy of the inferred $\log M_*$, $\log Z_{\rm MW}$, and $\tau_{\rm ISM}$. 
    } 
    \label{fig:eta_photo}
\end{center}
\end{figure}


Next, we examine whether the accuracy and precision of our parameter inference
is impacted by signal-to-noise ratio (SNR) and photometric color. 
In Figure~\ref{fig:eta_photo}, we present $\eta_\Delta$ of our joint
SED modeling of spectra and photometry as a function of $r_{\rm fiber}$, $r$,
$g-r$, and $r-z$. 
$r_{\rm fiber}$ and $r$ magnitudes serve proxies of the SNR for the spectra and
photometry, respectively. 
In each row, we plot $\eta_\Delta$ for a different galaxy property: $\log M_*$,
$\avgsfr$, $\log Z_{\rm MW}$, $\tage$ and $\tauism$ (from top to bottom).
We find no significant dependence on SNR dependence for $M_*$, $\avgsfr$,
$\tage$, or $\tauism$. 
On the other hand, we find $Z_{\rm MW}$ is especially overestimated at low SNR
(faint $r_{\rm fiber} > 20$).  
This bias at low spectra SNR, highlights the importance of including DESI
spectra in the SED modeling. 


Besides $\avgsfr$, we find no significant dependence on SNR or color in the
inferred galaxy properties. 
We again confirm that the inferred $M_*$ and $\tau_{\rm ISM}$ values are
unbiased.
While the inferred $Z_{\rm MW}$ overestimate the true $Z_{\rm MW}$, the bias is
small $\sim 0.1$ dex and, more importantly, independent of SNR or color. 
Together with the results from Figure~\ref{fig:etas}, \emph{we conclude that with our
SED modeling we can infer robust constraints on $M_*$, $Z_{\rm MW}$, and
$\tau_{\rm ISM}$}.

The situation is more complex for $\avgsfr$. 
For galaxies with high SNR spectra and photometry, we find no significant bias
in the inferred $\avgsfr$. 
However, for $r_{\rm fiber} > 20.5$ and $r > 19$, inferred $\avgsfr$
overestimates the true $\avgsfr$. 
\todo{color dependence once we get to the bottom of that}  


\begin{figure}
\begin{center}
    \includegraphics[width=\textwidth]{figs/etas_msfr.pdf} \label{fig:etas_msfr}
    \caption{
        Accuracy and precision of the galaxy properties inferred from joint SED
        modeling of spectrophotometry as a function of the galaxies' true $M_*$
        and $\avgsfr$. 
        We present $\mu_{\Delta_{\theta}}$ and $\sigma_{\Delta_{\theta}}$ in
        ($M_*$, $\avgsfr$) bins for $\log M_*$, $\log\avgsfr$, $\log Z_{\rm
        MW}$, $t_{\rm age, MW}$ and $\tau_{\rm ISM}$ in the top and bottom
        panels respectively. 
    }
\end{center}
\end{figure}

